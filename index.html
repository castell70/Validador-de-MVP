<title>Sistema de Gesti√≥n de Servicios ITCPO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
.container {
  max-width: 1200px;
  margin: 20px auto;
  padding: 20px;
}

.hidden {
  display: none;
}

.form-group {
  margin-bottom: 1rem;
  min-width: 0; /* Prevents overflow */
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

th {
  background-color: #f2f2f2;
}

tr:hover {
  background-color: #f5f5f5;
  cursor: pointer;
}

button {
  padding: 0.5rem 1rem;
  margin: 0.5rem;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  /* 3D effect additions */
  box-shadow: 0 5px 0 #357a38;
  position: relative;
  top: 0;
  transition: all 0.1s ease;
}

button:hover {
  background-color: #45a049;
}

button:active {
  top: 3px;
  box-shadow: 0 2px 0 #357a38;
}

/* Update nav styling to separate header and buttons */
.nav {
  background-color: #ff8c00;
  padding: 0; /* Remove padding from main nav */
  display: block; /* Change from flex to block */
  margin-bottom: 0; /* Remove margin */
}

/* New header section styling */
.nav-header {
  background-color: #ff8c00;
  padding: 30px 10px; /* Increased from 10px */
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 0; /* Remove margin */
}

/* New buttons section styling */
.nav-buttons {
  background-color: #f0f0f0; /* Cambiado de naranja a gris claro */
  padding: 10px;
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  border-top: 1px solid rgba(0,0,0,0.1); /* Cambiado a Negro transparente */
}

/* Colores diferentes para cada bot√≥n */
.nav-buttons button:nth-child(1) { /* Clientes */
  background-color: #4CAF50; /* Verde */
  box-shadow: 0 5px 0 #357a38;
}

.nav-buttons button:nth-child(1):hover {
  background-color: #45a049;
}

.nav-buttons button:nth-child(1):active {
  box-shadow: 0 2px 0 #357a38;
}

.nav-buttons button:nth-child(2) { /* Servicios */
  background-color: #f44336; /* Rojo */
  box-shadow: 0 5px 0 #d32f2f;
}

.nav-buttons button:nth-child(2):hover {
  background-color: #da190b;
}

.nav-buttons button:nth-child(2):active {
  box-shadow: 0 2px 0 #d32f2f;
}

.nav-buttons button:nth-child(3) { /* Reportes */
  background-color: #2196F3; /* Azul */
  box-shadow: 0 5px 0 #1976D2;
}

.nav-buttons button:nth-child(3):hover {
  background-color: #0b7dda;
}

.nav-buttons button:nth-child(3):active {
  box-shadow: 0 2px 0 #1976D2;
}

.nav-buttons button:nth-child(4) { /* Exportar JSON */
  background-color: #9C27B0; /* Morado */
  box-shadow: 0 5px 0 #7B1FA2;
}

.nav-buttons button:nth-child(4):hover {
  background-color: #7B1FA2;
}

.nav-buttons button:nth-child(4):active {
  box-shadow: 0 2px 0 #7B1FA2;
}

.nav-buttons button:nth-child(5) { /* Importar JSON */
  background-color: #FF9800; /* Naranja */
  box-shadow: 0 5px 0 #F57C00;
}

.nav-buttons button:nth-child(5):hover {
  background-color: #e68a00;
}

.nav-buttons button:nth-child(5):active {
  box-shadow: 0 2px 0 #F57C00;
}

/* Reduce vertical size of header */
.nav-header .logo-text {
  font-size: 2.5em; /* Increased from 1.5em */
  color: white;
  font-weight: bold;
  margin: 0;
  line-height: 1.2;
}

.nav-header .system-title {
  color: white;
  font-size: 1.2em; /* Restored from 1em */
  margin: 5px 0 0 0;
  padding: 0;
}

/* Add margin to main containers to separate from nav */
.container {
  max-width: 1200px;
  margin: 20px auto;
  padding: 20px;
}

/* Add legend styling */
.nav-legend {
  color: white;
  font-weight: bold;
  text-align: right;
  margin-top: 10px;
  padding-right: 20px;
  font-size: 14px;
  width: 100%;
}

h3 {
  background-color: #0066cc;
  color: white;
  padding: 10px;
  margin-top: 20px;
}

.json-controls {
  margin: 20px 0;
  padding: 10px;
  background: #f5f5f5;
}

/* Adjusting width for date columns - Modified for better date display */
#reportTable table td:nth-child(4) {
  min-width: 100px; /* Adjust width for date column */
}

#serviceList table td:nth-child(4) {
  min-width: 100px; /* Adjust width for date column */
}

.jspdf-autotable td:nth-child(4) {
  min-width: 100px;
  white-space: nowrap;
}

/* Column width controls for service list table */
#serviceList table td:nth-child(1) { /* Transaction Code */
  width: 12%;
}
#serviceList table td:nth-child(2) { /* Client Code */
  width: 12%;
}
#serviceList table td:nth-child(3) { /* Description */
  width: 30%; /* Reduced description column width */
  max-width: 300px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#serviceList table td:nth-child(4) { /* Date */
  width: 15%;
  min-width: 120px; /* Ensure date has enough space */
}
#serviceList table td:nth-child(5) { /* Amount */
  width: 15%;
}
#serviceList table td:nth-child(6) { /* Status */
  width: 16%;
}

/* Add text overflow control for all columns */
#serviceList table td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 0; /* Forces text truncation to work properly */
}

/* Add hover tooltip for truncated cells */
#serviceList table td:hover {
  position: relative;
  overflow: visible;
  white-space: normal;
  background: white;
  z-index: 1;
}

/* Form grid layout */
#clientForm {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* Changed to fixed 3 columns */
  gap: 25px;
  margin: 30px 0;
  padding: 30px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 140, 0, 0.2);
}

/* Adjust specific field sizes for 3-column layout */
#clientForm .form-group:nth-child(1) { /* Code */
  grid-column: span 1;
}

#clientForm .form-group:nth-child(2) { /* Name */
  grid-column: span 2;
}

#clientForm .form-group:nth-child(3) { /* Registration */
  grid-column: span 1;
}

#clientForm .form-group:nth-child(4) { /* Business Type */
  grid-column: span 1;
}

#clientForm .form-group:nth-child(5) { /* Address */
  grid-column: span 3; /* Make address field span 3 columns (full width) */
}

#clientForm .form-group:nth-child(6) { /* Phone */
  grid-column: span 1; /* Will naturally start on a new row */
}

/* Button group adjustment */
#clientForm .button-group {
  grid-column: 1 / -1;
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 20px;
}

/* Update the grid layout for the service form */
#serviceForm {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 25px; /* Consistent with client form */
  margin: 30px 0; /* Consistent with client form */
  padding: 30px; /* Consistent with client form */
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); /* Consistent with client form */
  border-radius: 12px; /* Consistent with client form */
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); /* Consistent with client form */
  border: 1px solid rgba(255, 140, 0, 0.2); /* Consistent with client form */
}

/* Make specific fields span columns as needed */
#serviceForm .form-group:nth-child(1) { /* Client Code */
  grid-column: span 2;
}

#serviceForm .form-group:nth-child(2) { /* Transaction ID */
  grid-column: span 1;
}

#serviceForm .form-group:nth-child(3) { /* Description */
  grid-column: span 3;
}

#serviceForm .form-group:nth-child(4), /* Date */
#serviceForm .form-group:nth-child(5), /* Amount */
#serviceForm .form-group:nth-child(6) { /* Status */
  grid-column: span 1;
}

/* Input styling adjustments */
#serviceForm input[type="text"],
#serviceForm input[type="date"],
#serviceForm input[type="number"],
#serviceForm select {
  width: 100%;
  padding: 12px 16px; /* Consistent with client form inputs */
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s ease;
  background: white;
  box-sizing: border-box; /* Crucial for consistent width with padding */
}

#serviceForm input[type="text"],
#serviceForm input[type="date"],
#serviceForm input[type="number"],
#serviceForm select { /* Exclude textarea from fixed height */
  width: 100%;
  padding: 0 16px; /* Adjusted vertical padding, let height control it */
  height: 46px; /* Set explicit height for better visibility */
  line-height: 1; /* For better vertical alignment within the fixed height */
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s ease;
  background: white;
  box-sizing: border-box;
}

/* Update the service form description input styling */
#serviceForm .form-group:nth-child(3) textarea {
  width: 100%;
  min-height: 90px; /* Increased min-height for better visibility */
  resize: vertical;
  padding: 8px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 16px; /* Increased font size */
}

/* Form controls for reports section */
#reports .form-controls {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* Change from 2 to 4 columns */
  gap: 10px; /* Reduce gap from 20px to 10px */
  margin-bottom: 20px;
  align-items: end;
}

/* Make buttons span full width at bottom */
#clientForm button, #serviceForm button {
  grid-column: 1 / -1; /* Spans all columns */
  width: auto; /* Override previous width */
  display: inline-block;
  margin-right: 10px;
}

/* Wrapper for buttons in reports */
#reports .button-group {
  grid-column: 1 / -1;
  display: flex;
  gap: 10px;
}

/* Wrapper for buttons */
.button-group {
  grid-column: 1 / -1;
  display: flex;
  gap: 10px;
}

/* Update input/select sizing */
select, input {
  width: 100%;
  max-width: none;
  box-sizing: border-box;
}

/* Add this to the existing CSS section */
#serviceListFilter {
  width: auto; /* Override the 100% width set for all selects */
  min-width: 200px; /* Set a reasonable minimum width */
  margin-bottom: 20px; /* Add some space below the filter */
}

#serviceClientFilter {
  width: auto;
  min-width: 200px;
  margin-bottom: 20px;
}

/* Update the filter container to show filters side by side */
#services .filter-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-bottom: 20px;
  align-items: end;
}

/* Add styles for the total amount display */
.totals-container {
  background: #ff8c00;
  padding: 10px;
  border-radius: 4px;
  color: white;
  font-weight: bold;
  text-align: center;
  margin-bottom: 20px;
}

/* Ensure consistent height and styling for report filter inputs/selects */
#reports input[type="date"],
#reports select {
  width: 100%;
  height: 38px;
  padding: 8px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* Adjust button group spacing in reports */
#reports .button-group {
  margin-top: 10px;
}

/* Add specific styles for report date inputs to prevent them from being too wide */
#reports input[type="date"] {
  min-width: 140px;
}

/* Add styles for the help button and modal */
.help-button {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background-color: #0066cc;
  color: white;
  font-size: 24px;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 0 #004999;
  z-index: 1000;
}

.help-button:hover {
  background-color: #0055b3;
}

.help-button:active {
  transform: translateY(2px);
  box-shadow: 0 2px 0 #004999;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1001;
}

.modal-content {
  position: relative;
  background-color: #fff;
  margin: 50px auto;
  padding: 20px;
  width: 80%;
  max-width: 800px;
  max-height: 80vh;
  overflow-y: auto;
  border-radius: 8px;
}

.close-button {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}

.help-section {
  margin-bottom: 20px;
}

.help-section h3 {
  color: white;
  background-color: #0066cc;
  padding: 10px;
  border-radius: 4px;
  margin-top: 15px;
  margin-bottom: 10px;
}

/* Professional form styling for client registration */
#clientForm {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* Changed to fixed 3 columns */
  gap: 25px;
  margin: 30px 0;
  padding: 30px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 140, 0, 0.2);
}

#clientForm .form-group {
  margin-bottom: 0;
  position: relative;
}

#clientForm label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #2c3e50;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

#clientForm input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s ease;
  background: white;
}

#clientForm input:focus {
  outline: none;
  border-color: #ff8c00;
  box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.1);
  transform: translateY(-1px);
}

#clientForm input:hover {
  border-color: #ff8c00;
}

#clientForm .button-group {
  grid-column: 1 / -1;
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 20px;
}

#clientForm button {
  position: relative;
  width: 60px;
  height: 45px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
}

#clientForm button[type="submit"] {
  background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%);
  box-shadow: 0 4px 15px rgba(0, 180, 219, 0.4);
}

#clientForm button[type="submit"]:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 180, 219, 0.6);
}

#clientForm button[onclick*="delete"] {
  background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
}

#clientForm button[onclick*="delete"]:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6);
}

#clientForm button:active {
  transform: translateY(0);
}

/* Professional form styling for service registration */
#serviceForm {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 25px; /* Consistent with client form */
  margin: 30px 0; /* Consistent with client form */
  padding: 30px; /* Consistent with client form */
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); /* Consistent with client form */
  border-radius: 12px; /* Consistent with client form */
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); /* Consistent with client form */
  border: 1px solid rgba(255, 140, 0, 0.2); /* Consistent with client form */
}

#serviceForm .form-group {
  margin-bottom: 0; /* Override default .form-group margin */
  position: relative;
}

#serviceForm label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #2c3e50;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

#serviceForm input[type="text"],
#serviceForm input[type="date"],
#serviceForm input[type="number"],
#serviceForm select {
  width: 100%;
  padding: 12px 16px; /* Consistent with client form inputs */
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s ease;
  background: white;
  box-sizing: border-box; /* Crucial for consistent width with padding */
}

#serviceForm input[type="text"],
#serviceForm input[type="date"],
#serviceForm input[type="number"],
#serviceForm select { /* Exclude textarea from fixed height */
  width: 100%;
  padding: 0 16px; /* Adjusted vertical padding, let height control it */
  height: 46px; /* Set explicit height for better visibility */
  line-height: 1; /* For better vertical alignment within the fixed height */
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s ease;
  background: white;
  box-sizing: border-box;
}

#serviceForm input:focus,
#serviceForm select:focus {
  outline: none;
  border-color: #ff8c00;
  box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.1);
  transform: translateY(-1px);
}

#serviceForm input:hover,
#serviceForm select:hover {
  border-color: #ff8c00;
}

/* Specific adjustments for textarea within service form */
#serviceForm textarea {
  min-height: 90px; /* Increased min-height for better visibility */
  resize: vertical;
}

/* Button group specific to service form */
#serviceForm .button-group {
  grid-column: 1 / -1;
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 20px;
}

/* Button styling for service form */
#serviceForm button {
  position: relative;
  width: 60px;
  height: 45px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
}

#serviceForm button[type="submit"] {
  background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%); /* Celeste */
  box-shadow: 0 4px 15px rgba(0, 180, 219, 0.4);
}

#serviceForm button[type="submit"]:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 180, 219, 0.6);
}

#serviceForm button[onclick*="delete"] {
  background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); /* Orange */
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
}

#serviceForm button[onclick*="delete"]:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6);
}

#serviceForm button:active {
  transform: translateY(0);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  #clientForm {
    grid-template-columns: 1fr;
    padding: 20px;
  }
  /* Apply same responsive adjustment to service form */
  #serviceForm {
    grid-template-columns: 1fr;
    padding: 20px;
  }
  #serviceForm .form-group:nth-child(1),
  #serviceForm .form-group:nth-child(2),
  #serviceForm .form-group:nth-child(3),
  #serviceForm .form-group:nth-child(4),
  #serviceForm .form-group:nth-child(5),
  #serviceForm .form-group:nth-child(6) {
    grid-column: span 1; /* Reset column spanning on small screens */
  }
}

/* Table improvements */
#clientList {
  margin-top: 30px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

#clientList th {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-weight: 600;
  padding: 15px 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

#clientList td {
  padding: 12px 10px;
  border-bottom: 1px solid #eee;
}

#clientList tr:hover {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  transform: scale(1.01);
  transition: all 0.2s ease;
}

#reportTable table {
  width: 100%;
  margin-top: 20px;
  border-collapse: collapse;
}

#reportTable th, #reportTable td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

#reportTable th {
  background-color: #f2f2f2;
}

#reportTable tr:nth-child(even) {
  background-color: #f9f9f9;
}

#reportTable tr:hover {
  background-color: #f5f5f5;
}

#reportTable p {
  margin: 10px 0;
}

/* Toast Notification Styling */
#toast {
  visibility: hidden; /* Hidden by default. Visible on click */
  min-width: 250px; /* Set a default minimum width */
  margin-left: -125px; /* Divide value of min-width by 2 */
  background-color: #333; /* Black background color */
  color: #fff; /* White text color */
  text-align: center; /* Centered text */
  border-radius: 8px; /* Rounded borders */
  padding: 16px; /* Padding */
  position: fixed; /* Sit on top of the screen */
  z-index: 1002; /* Add a z-index if needed */
  left: 50%; /* Center the snackbar */
  bottom: 30px; /* 30px from the bottom */
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  opacity: 0;
  transition: opacity 0.5s, visibility 0.5s;
}

#toast.show {
  visibility: visible; /* Show the snackbar */
  -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
  opacity: 1;
}

/* Animations to fade the snackbar in and out */
@-webkit-keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 30px; opacity: 1;}
}

@keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 30px; opacity: 1;}
}

@-webkit-keyframes fadeout {
  from {bottom: 30px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
}

@keyframes fadeout {
  from {bottom: 30px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
}
</style>

<body>
<div class="nav">
  <div class="nav-header">
    <span class="logo-text">ITCPO</span>
    <h1 class="system-title">Sistema de Control de Clientes y Servicios</h1>
    <div class="nav-legend">Powered by ITCPO</div>
  </div>
  <div class="nav-buttons">
    <button onclick="showSection('clients')">Clientes</button>
    <button onclick="showSection('services')">Servicios</button>
    <button onclick="showSection('reports')">Reportes</button>
    <button onclick="exportToJson()">Exportar JSON</button>
    <input type="file" id="jsonFileInput" style="display:none" onchange="importFromJson(this.files[0])">
    <button onclick="document.getElementById('jsonFileInput').click()">Importar JSON</button>
  </div>
</div>
<div id="clients" class="container">
  <h2>Registro de Clientes</h2>
  <form id="clientForm">
    <div class="form-group">
      <label>C√≥digo:</label>
      <input type="text" id="clientCode" required>
    </div>
    <div class="form-group">
      <label>Nombre:</label>
      <input type="text" id="clientName" required>
    </div>
    <div class="form-group">
      <label>Registro:</label>
      <input type="text" id="clientRegistration" required>
    </div>
    <div class="form-group">
        <label>Giro de la Empresa:</label>
        <input type="text" id="clientBusinessType" required>
      </div>
    <div class="form-group">
      <label>Direcci√≥n:</label>
      <input type="text" id="clientAddress" required>
    </div>
    <div class="form-group">
      <label>Tel√©fono:</label>
      <input type="tel" id="clientPhone" required>
    </div>
    <div class="form-group">
      <label>NIT:</label>
      <input type="text" id="clientNIT" required>
    </div>
    <div class="button-group">
      <button type="submit" title="Guardar">
        <i style="font-size: 18px;">üíæ</i>
      </button>
      <button type="button" onclick="deleteClient()" title="Eliminar">
        <i style="font-size: 18px;">üóëÔ∏è</i>
      </button>
    </div>
  </form>
  
  <h3>Lista de Clientes</h3>
  <table id="clientList">
    <thead>
      <tr>
        <th>C√≥digo</th>
        <th>Nombre</th>
        <th>Registro</th>
        <th>Giro</th>
        <th>Direcci√≥n</th>
        <th>Tel√©fono</th>
        <th>NIT</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="services" class="container hidden">
  <h2>Registro de Servicios</h2>
  <form id="serviceForm">
    <div class="form-group">
      <label>C√≥digo Cliente:</label>
      <select id="serviceClientCode" required>
        <option value="">Seleccione un cliente</option>
      </select>
    </div>
    <div class="form-group">
      <label>C√≥digo Transacci√≥n:</label>
      <input type="text" id="transactionId" required readonly>
    </div>
    <div class="form-group">
      <label>Descripci√≥n:</label>
      <textarea id="serviceDescription" required></textarea>
    </div>
    <div class="form-group">
      <label>Fecha:</label>
      <input type="date" id="serviceDate" required>
    </div>
    <div class="form-group">
      <label>Monto:</label>
      <input type="number" id="serviceAmount" required step="0.01">
    </div>
    <div class="form-group">
      <label>Estatus:</label>
      <select id="serviceStatus" required>
        <option value="Pendiente">Pendiente</option>
        <option value="Pagado">Pagado</option>
      </select>
    </div>
    <div class="button-group">
      <button type="submit" title="Guardar">
        <i style="font-size: 18px;">üíæ</i>
      </button>
      <button type="button" onclick="deleteService()" title="Eliminar">
        <i style="font-size: 18px;">üóëÔ∏è</i>
      </button>
    </div>
  </form>

  <h3>Lista de Servicios</h3>
  <div class="filter-container">
    <div class="form-group">
      <label>Filtrar por Estatus:</label>
      <select id="serviceListFilter">
        <option value="Todos">Todos</option>
        <option value="Pendiente">Pendiente</option>
        <option value="Pagado">Pagado</option>
      </select>
    </div>
    <div class="form-group">
      <label>Filtrar por Cliente:</label>
      <select id="serviceClientFilter">
        <option value="Todos">Todos</option>
      </select>
    </div>
    <div class="totals-container">
      <div>TOTAL</div>
      <div id="servicesTotal">$0.00</div>
    </div>
  </div>
  <table id="serviceList">
    <thead>
      <tr>
        <th>C√≥digo Transac</th>
        <th>C√≥digo Cliente</th>
        <th>Descripci√≥n</th>
        <th>Fecha_Trans</th>
        <th>Monto</th>
        <th>Estatus</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="reports" class="container hidden">
  <h2>Reportes de Servicios</h2>
  <div class="form-controls">
    <div class="form-group">
      <label>Fecha Inicio:</label>
      <input type="date" id="startDate">
    </div>
    <div class="form-group">
      <label>Fecha Fin:</label>
      <input type="date" id="endDate">
    </div>
    <div class="form-group">
      <label>Cliente:</label>
      <select id="reportClientFilter">
        <option value="Todos">Todos</option>
      </select>
    </div>
    <div class="form-group">
      <label>Estatus:</label>
      <select id="filterStatus">
        <option value="Todos">Todos</option>
        <option value="Pendiente">Pendiente</option>
        <option value="Pagado">Pagado</option>
      </select>
    </div>
  </div>
  <div class="button-group">
    <button onclick="generateReport()">Generar Reporte</button>
    <button onclick="exportToPDF()">Exportar a PDF</button>
    <button onclick="exportToExcel()">Exportar a Excel</button>
  </div>
  <div id="reportTable"></div>
</div>

<button class="help-button" onclick="showHelp()">?</button>

<div id="helpModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeHelp()">&times;</span>
    <h2>Gu√≠a de Uso del Sistema</h2>
    
    <div class="help-section">
      <h3>Gesti√≥n de Clientes</h3>
      <ul>
        <li>Para agregar un nuevo cliente, complete todos los campos del formulario y presione "Guardar"</li>
        <li>Para editar un cliente existente, haga clic en su registro en la tabla y modifique los datos</li>
        <li>Para eliminar un cliente, selecci√≥nelo y presione el bot√≥n "Eliminar"</li>
      </ul>
    </div>

    <div class="help-section">
      <h3>Gesti√≥n de Servicios</h3>
      <ul>
        <li>Seleccione un cliente del men√∫ desplegable</li>
        <li>Complete los detalles del servicio: c√≥digo de transacci√≥n, descripci√≥n, fecha, monto y estatus</li>
        <li>Use los filtros para ver servicios espec√≠ficos por estatus o cliente</li>
        <li>El total mostrado se actualiza seg√∫n los filtros aplicados</li>
      </ul>
    </div>

    <div class="help-section">
      <h3>Reportes</h3>
      <ul>
        <li>Seleccione el rango de fechas para el reporte</li>
        <li>Filtre por cliente y/o estatus si lo desea</li>
        <li>Use los botones para exportar a PDF o Excel</li>
        <li>Los reportes mostrar√°n el total de los servicios filtrados</li>
      </ul>
    </div>

    <div class="help-section">
      <h3>Respaldo de Datos</h3>
      <ul>
        <li>Use "Exportar JSON" para guardar una copia de seguridad de todos los datos</li>
        <li>Use "Importar JSON" para restaurar datos desde una copia de seguridad previa</li>
      </ul>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
let clients = JSON.parse(localStorage.getItem('clients')) || [];
let services = JSON.parse(localStorage.getItem('services')) || [];

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.className = "show";
  setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
}

function saveDataToLocalStorage() {
  localStorage.setItem('clients', JSON.stringify(clients));
  localStorage.setItem('services', JSON.stringify(services));
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr + 'T00:00:00'); // Add time component to avoid timezone issues
  // Check if date is valid
  if (isNaN(date.getTime())) {
    console.warn('Invalid date string:', dateStr);
    return dateStr; // Return original string if parsing fails
  }
  return date.toLocaleDateString('es-ES', {
    timeZone: 'UTC', // Force UTC timezone
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
}

// Helper function to prepare the service form for a new entry
function prepareServiceFormForNewEntry() {
  // Reset the form (clears current values but keeps dropdown options)
  document.getElementById('serviceForm').reset();

  // 1. Generate next transaction ID (correlative)
  let maxId = 0;
  if (services.length > 0) {
    maxId = services.reduce((currentMax, service) => {
      const idNum = parseInt(service.transactionId);
      // Ensure it's a number and greater than currentMax
      return (isNaN(idNum) || idNum < currentMax) ? currentMax : idNum;
    }, 0); // Start from 0 to handle cases where there are no services or invalid IDs
  }
  const nextId = maxId + 1;
  document.getElementById('transactionId').value = nextId.toString();
  // The transactionId input is set to readonly in HTML, so no need to set it here.

  // 2. Preload current date
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
  const day = String(today.getDate()).padStart(2, '0');
  document.getElementById('serviceDate').value = `${year}-${month}-${day}`;
}

function showSection(section) {
  document.getElementById('clients').classList.add('hidden');
  document.getElementById('services').classList.add('hidden');
  document.getElementById('reports').classList.add('hidden');
  document.getElementById(section).classList.remove('hidden');
  
  if (section === 'clients') {
    updateClientList();
    document.getElementById('clientForm').reset(); // Clear client form on section change
  }
  if (section === 'services') {
    updateServiceList();
    populateClientSelect();
    populateClientFilter();
    // After populating, prepare the form for a new entry (auto-generate ID and date)
    prepareServiceFormForNewEntry(); 
  }
  if (section === 'reports') {
    populateReportClientFilter();
    document.getElementById('startDate').value = ''; // Clear report dates on section change
    document.getElementById('endDate').value = '';
    document.getElementById('filterStatus').value = 'Todos';
    document.getElementById('reportClientFilter').value = 'Todos';
    document.getElementById('reportTable').innerHTML = ''; // Clear report table
  }
}

function populateClientSelect() {
  const select = document.getElementById('serviceClientCode');
  select.innerHTML = '<option value="">Seleccione un cliente</option>';
  
  clients.sort((a, b) => a.name.localeCompare(b.name)).forEach(client => {
    const option = document.createElement('option');
    option.value = client.code;
    option.textContent = `${client.code} - ${client.name}`;
    select.appendChild(option);
  });
}

// Populate the client filter dropdown
function populateClientFilter() {
  const select = document.getElementById('serviceClientFilter');
  select.innerHTML = '<option value="Todos">Todos</option>';
  
  clients.sort((a, b) => a.name.localeCompare(b.name)).forEach(client => {
    const option = document.createElement('option');
    option.value = client.code;
    option.textContent = `${client.code} - ${client.name}`;
    select.appendChild(option);
  });
}

// Populate the report client filter dropdown
function populateReportClientFilter() {
  const select = document.getElementById('reportClientFilter');
  select.innerHTML = '<option value="Todos">Todos</option>';
  
  clients.sort((a, b) => a.name.localeCompare(b.name)).forEach(client => {
    const option = document.createElement('option');
    option.value = client.code;
    option.textContent = `${client.code} - ${client.name}`;
    select.appendChild(option);
  });
}

// Client functions
document.getElementById('clientForm').onsubmit = function(e) {
  e.preventDefault();
  const code = document.getElementById('clientCode').value.trim();
  const name = document.getElementById('clientName').value.trim();
  const registration = document.getElementById('clientRegistration').value.trim();
  const businessType = document.getElementById('clientBusinessType').value.trim();
  const address = document.getElementById('clientAddress').value.trim();
  const phone = document.getElementById('clientPhone').value.trim();
  const nit = document.getElementById('clientNIT').value.trim();

  if (!code || !name) {
      showToast('C√≥digo y Nombre de cliente son campos obligatorios.');
      return;
  }
  
  const clientIndex = clients.findIndex(c => c.code === code);
  if (clientIndex === -1) {
    // Check for duplicate code if adding new client
    if (clients.some(c => c.code === code)) {
        showToast('Ya existe un cliente con este c√≥digo.');
        return;
    }
    clients.push({ code, name, registration, businessType, address, phone, nit });
    showToast('Cliente agregado exitosamente.');
  } else {
    clients[clientIndex] = { code, name, registration, businessType, address, phone, nit };
    showToast('Cliente actualizado exitosamente.');
  }
  
  saveDataToLocalStorage();
  updateClientList();
  populateClientSelect();
  populateClientFilter(); // Update client filter
  populateReportClientFilter(); // Update report client filter
  this.reset();
};

function deleteClient() {
  const clientCode = document.getElementById('clientCode').value.trim();
  if (!clientCode) {
    showToast('Seleccione un cliente para eliminar.');
    return;
  }
  if (!confirm('¬øEst√° seguro de eliminar este cliente y todos sus servicios asociados?')) {
    showToast('Operaci√≥n cancelada.'); // Added toast for cancellation
    return;
  }
  
  clients = clients.filter(c => c.code !== clientCode);
  services = services.filter(s => s.clientCode !== clientCode); // Delete associated services
  
  saveDataToLocalStorage();
  updateClientList();
  populateClientSelect();
  populateClientFilter(); // Update client filter
  populateReportClientFilter(); // Update report client filter
  document.getElementById('clientForm').reset();
  showToast('Cliente y servicios asociados eliminados exitosamente.');
}

function updateClientList() {
  const tbody = document.querySelector('#clientList tbody');
  tbody.innerHTML = '';
  
  clients.forEach(client => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${client.code}</td>
      <td>${client.name}</td>
      <td>${client.registration || ''}</td>
      <td>${client.businessType || ''}</td>
      <td>${client.address || ''}</td>
      <td>${client.phone || ''}</td>
      <td>${client.nit || ''}</td>
    `;
    tr.onclick = () => selectClient(client.code);
    tbody.appendChild(tr);
  });
}

function selectClient(code) {
  const client = clients.find(c => c.code === code);
  if (client) {
    document.getElementById('clientCode').value = client.code;
    document.getElementById('clientName').value = client.name;
    document.getElementById('clientRegistration').value = client.registration || '';
    document.getElementById('clientBusinessType').value = client.businessType || '';
    document.getElementById('clientAddress').value = client.address || '';
    document.getElementById('clientPhone').value = client.phone || '';
    document.getElementById('clientNIT').value = client.nit || '';
  }
}

// Service functions
document.getElementById('serviceForm').onsubmit = function(e) {
  e.preventDefault();
  const service = {
    clientCode: document.getElementById('serviceClientCode').value,
    transactionId: document.getElementById('transactionId').value.trim(),
    description: document.getElementById('serviceDescription').value.trim(),
    date: document.getElementById('serviceDate').value,
    amount: parseFloat(document.getElementById('serviceAmount').value),
    status: document.getElementById('serviceStatus').value
  };

  if (!service.clientCode || !service.transactionId || !service.description || !service.date || isNaN(service.amount)) {
    showToast('Todos los campos de servicio son obligatorios.');
    return;
  }
  
  const serviceIndex = services.findIndex(s => s.transactionId === service.transactionId);
  if (serviceIndex === -1) {
    // New service
    // A check for duplicate transaction ID is included, although it's auto-generated and should be unique
    if (services.some(s => s.transactionId === service.transactionId)) {
        showToast('Error: Ya existe un servicio con este c√≥digo de transacci√≥n. Por favor, recargue el formulario.');
        return;
    }
    services.push(service);
    showToast('Servicio agregado exitosamente.');
  } else {
    // Existing service: Update
    services[serviceIndex] = service;
    showToast('Servicio actualizado exitosamente.');
  }
  
  saveDataToLocalStorage();
  updateServiceList();
  prepareServiceFormForNewEntry(); // Prepare form for the next new entry
};

function deleteService() {
  const transactionId = document.getElementById('transactionId').value.trim();
  if (!transactionId) {
    showToast('Seleccione un servicio para eliminar.');
    return;
  }
  if (!confirm('¬øEst√° seguro de eliminar este servicio?')) {
    showToast('Operaci√≥n cancelada.'); // Added toast for cancellation
    return;
  }
  
  services = services.filter(s => s.transactionId !== transactionId);
  saveDataToLocalStorage();
  updateServiceList();
  prepareServiceFormForNewEntry(); // After deletion, prepare for a new entry
  showToast('Servicio eliminado exitosamente.');
}

document.getElementById('serviceListFilter').addEventListener('change', updateServiceList);
document.getElementById('serviceClientFilter').addEventListener('change', updateServiceList);

function updateServiceList() {
  const tbody = document.querySelector('#serviceList tbody');
  tbody.innerHTML = '';
  
  const filterStatus = document.getElementById('serviceListFilter').value;
  const filterClient = document.getElementById('serviceClientFilter').value;

  let filteredServices = services;
  
  // Apply status filter
  if (filterStatus !== 'Todos') {
    filteredServices = filteredServices.filter(service => service.status === filterStatus);
  }
  
  // Apply client filter
  if (filterClient !== 'Todos') {
    filteredServices = filteredServices.filter(service => service.clientCode === filterClient);
  }

  // Calculate total
  const total = filteredServices.reduce((sum, service) => sum + service.amount, 0);
  document.getElementById('servicesTotal').textContent = `$${total.toFixed(2)}`;

  // Sort by date ascending
  filteredServices.sort((a, b) => new Date(a.date) - new Date(b.date));

  if (filteredServices.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay servicios para mostrar con los filtros seleccionados.</td></tr>';
    return;
  }

  filteredServices.forEach(service => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${service.transactionId}</td>
      <td>${service.clientCode}</td>
      <td>${service.description}</td>
      <td>${formatDate(service.date)}</td>
      <td>$${service.amount.toFixed(2)}</td>
      <td>${service.status}</td>
    `;
    tr.onclick = () => selectService(service.transactionId);
    tbody.appendChild(tr);
  });
}

function selectService(transactionId) {
  const service = services.find(s => s.transactionId === transactionId);
  if (service) {
    document.getElementById('serviceClientCode').value = service.clientCode;
    document.getElementById('transactionId').value = service.transactionId; // This field remains readonly
    document.getElementById('serviceDescription').value = service.description;
    document.getElementById('serviceDate').value = service.date;
    document.getElementById('serviceAmount').value = service.amount;
    document.getElementById('serviceStatus').value = service.status;
  }
}

// Report functions
function generateReport() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const status = document.getElementById('filterStatus').value;
  const clientFilter = document.getElementById('reportClientFilter').value;

  if (!startDate || !endDate) {
    showToast('Por favor seleccione un rango de fechas para generar el reporte.');
    return;
  }

  // Ensure dates are parsed consistently at midnight UTC
  const startDateTime = new Date(startDate + 'T00:00:00');
  const endDateTime = new Date(endDate + 'T00:00:00');

  if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
    showToast('Fechas de inicio o fin inv√°lidas.');
    return;
  }

  if (startDateTime > endDateTime) {
    showToast('La fecha de inicio no puede ser posterior a la fecha de fin.');
    return;
  }

  let filteredServices = services.filter(service => {
    // Create date objects with time set to midnight for consistent comparison
    const serviceDate = new Date(service.date + 'T00:00:00');
    
    const dateFilter = serviceDate >= startDateTime && 
                      serviceDate <= endDateTime;
    const statusFilter = status === 'Todos' || service.status === status;
    const clientFilterMatch = clientFilter === 'Todos' || service.clientCode === clientFilter;
    
    return dateFilter && statusFilter && clientFilterMatch;
  });

  // Sort by date ascending
  filteredServices.sort((a, b) => new Date(a.date) - new Date(b.date));

  const totalAmount = filteredServices.reduce((sum, service) => sum + service.amount, 0);
  const iva = totalAmount * 0.13;
  const totalConIVA = totalAmount + iva;

  const reportTable = document.getElementById('reportTable');
  reportTable.innerHTML = `
    <h3>Reporte de Servicios</h3>
    <p><strong>Per√≠odo:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}</p>
    ${clientFilter !== 'Todos' ? `<p><strong>Cliente:</strong> ${getClientName(clientFilter)}</p>` : ''}
    ${status !== 'Todos' ? `<p><strong>Estatus:</strong> ${status}</p>` : ''}
    <table>
      <thead>
        <tr>
          <th>C√≥digo Trs</th>
          <th>C√≥digo Cliente</th>
          <th>Descripci√≥n</th>
          <th>Fecha</th>
          <th>Monto</th>
          <th>Estatus</th>
        </tr>
      </thead>
      <tbody>
        ${filteredServices.length > 0 ? filteredServices.map(service => `
          <tr>
            <td>${service.transactionId}</td>
            <td>${service.clientCode}</td>
            <td>${service.description}</td>
            <td>${formatDate(service.date)}</td>
            <td>$${service.amount.toFixed(2)}</td>
            <td>${service.status}</td>
          </tr>
        `).join('') : '<tr><td colspan="6" style="text-align: center;">No hay servicios para este reporte.</td></tr>'}
      </tbody>
    </table>
    <p style="margin-top: 20px;"><strong>Total sin IVA:</strong> $${totalAmount.toFixed(2)}</p>
    <p style="margin-top: 5px;"><strong>IVA (13%):</strong> $${iva.toFixed(2)}</p>
    <p style="margin-top: 5px;"><strong>Total con IVA:</strong> $${totalConIVA.toFixed(2)}</p>
  `;
}

// Add helper function to get client name
function getClientName(clientCode) {
  const client = clients.find(c => c.code === clientCode);
  return client ? `${client.code} - ${client.name}` : clientCode;
}

function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const status = document.getElementById('filterStatus').value;
  const clientFilter = document.getElementById('reportClientFilter').value;

  if (!startDate || !endDate) {
    showToast('Por favor seleccione un rango de fechas para exportar a PDF.');
    return;
  }

  // Ensure dates are parsed consistently at midnight UTC for filtering
  const startDateTime = new Date(startDate + 'T00:00:00');
  const endDateTime = new Date(endDate + 'T00:00:00');
  
  doc.text('Reporte de Servicios', 14, 15);
  doc.setFontSize(11);
  doc.text(`Per√≠odo: ${formatDate(startDate)} - ${formatDate(endDate)}`, 14, 25);
  doc.text(`Estatus: ${status}`, 14, 30);
  
  if (clientFilter !== 'Todos') {
    doc.text(`Cliente: ${getClientName(clientFilter)}`, 14, 35);
  }

  const filteredServices = services.filter(service => {
    const serviceDate = new Date(service.date + 'T00:00:00'); // Consistent date parsing
    const dateFilter = serviceDate >= startDateTime && 
                      serviceDate <= endDateTime;
    const statusFilter = status === 'Todos' || service.status === status;
    const clientFilterMatch = clientFilter === 'Todos' || service.clientCode === clientFilter;
    
    return dateFilter && statusFilter && clientFilterMatch;
  });

  // Sort by date ascending
  filteredServices.sort((a, b) => new Date(a.date) - new Date(b.date));

  const tableData = filteredServices.map(service => [
    service.transactionId,
    service.clientCode,
    service.description,
    formatDate(service.date),
    `$${service.amount.toFixed(2)}`,
    service.status
  ]);

  const totalAmount = filteredServices.reduce((sum, service) => sum + service.amount, 0);
  const iva = totalAmount * 0.13;
  const totalConIVA = totalAmount + iva;

  doc.autoTable({
    head: [['C√≥digo Trs', 'C√≥digo Cliente', 'Descripci√≥n', 'Fecha', 'Monto', 'Estatus']],
    body: tableData,
    startY: 40, // Adjusted startY to give more space for header text
    theme: 'grid',
    columnStyles: {
      3: {cellWidth: 25} // Set specific width for date column
    }
  });

  const finalY = doc.previousAutoTable.finalY + 10;
  doc.text(`Total sin IVA: $${totalAmount.toFixed(2)}`, 14, finalY);
  doc.text(`IVA (13%): $${iva.toFixed(2)}`, 14, finalY + 10);
  doc.text(`Total con IVA: $${totalConIVA.toFixed(2)}`, 14, finalY + 20);
  doc.save('reporte-servicios.pdf');
  showToast('Reporte exportado a PDF exitosamente.'); // Added toast
}

function exportToExcel() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const status = document.getElementById('filterStatus').value;
  const clientFilter = document.getElementById('reportClientFilter').value;

  if (!startDate || !endDate) {
    showToast('Por favor seleccione un rango de fechas para exportar a Excel.');
    return;
  }

  // Ensure dates are parsed consistently at midnight UTC for filtering
  const startDateTime = new Date(startDate + 'T00:00:00');
  const endDateTime = new Date(endDate + 'T00:00:00');

  const filteredServices = services.filter(service => {
    const serviceDate = new Date(service.date + 'T00:00:00'); // Consistent date parsing
    const dateFilter = serviceDate >= startDateTime && 
                      serviceDate <= endDateTime;
    const statusFilter = status === 'Todos' || service.status === status;
    const clientFilterMatch = clientFilter === 'Todos' || service.clientCode === clientFilter;
    
    return dateFilter && statusFilter && clientFilterMatch;
  });

  // Sort by date ascending
  filteredServices.sort((a, b) => new Date(a.date) - new Date(b.date));

  const worksheet = XLSX.utils.json_to_sheet(filteredServices.map(service => ({
    'C√≥digo Transacci√≥n': service.transactionId,
    'C√≥digo Cliente': service.clientCode,
    'Descripci√≥n': service.description,
    'Fecha': formatDate(service.date), // Format date for Excel output
    'Monto': service.amount,
    'Estatus': service.status
  })));

  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Servicios');
  XLSX.writeFile(workbook, 'reporte-servicios.xlsx');
  showToast('Reporte exportado a Excel exitosamente.'); // Added toast
}

function exportToJson() {
  // Create data object
  const data = {
    clients: clients,
    services: services
  };
  
  // Create blob with JSON data
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  
  // Create URL for blob
  const url = window.URL.createObjectURL(blob);
  
  // Create temporary download link
  const downloadAnchor = document.createElement('a');
  downloadAnchor.href = url;
  downloadAnchor.download = "sistema-servicios.json";
  
  // Append to body, click and cleanup
  document.body.appendChild(downloadAnchor);
  downloadAnchor.click();
  
  // Cleanup
  window.URL.revokeObjectURL(url);
  downloadAnchor.remove();
  showToast('Datos exportados exitosamente.');
}

function importFromJson(file) {
  if (!file) {
    showToast('Ning√∫n archivo seleccionado para importar.'); // Added toast
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.clients && Array.isArray(data.clients) && data.services && Array.isArray(data.services)) {
        clients = data.clients;
        services = data.services;
        saveDataToLocalStorage();
        updateClientList();
        updateServiceList();
        populateClientSelect();
        populateClientFilter(); // Update client filter
        populateReportClientFilter(); // Update report client filter
        // After importing, ensure service form is ready for a new entry
        prepareServiceFormForNewEntry(); 
        showToast('Datos importados exitosamente');
      } else {
        showToast('Formato de archivo JSON inv√°lido. Se esperan las claves "clients" y "services" como arrays.');
      }
    } catch (error) {
      showToast('Error al leer el archivo o formato JSON incorrecto: ' + error.message);
      console.error('Error importing JSON:', error);
    }
  };
  reader.onerror = function() {
    showToast('Error al leer el archivo.');
  };
  reader.readAsText(file);
}

// Help functions
function showHelp() {
  document.getElementById('helpModal').style.display = 'block';
}

function closeHelp() {
  document.getElementById('helpModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('helpModal');
  if (event.target === modal) {
    closeHelp();
  }
}

// Initialize the page
showSection('clients');
</script>
</body>
</html>